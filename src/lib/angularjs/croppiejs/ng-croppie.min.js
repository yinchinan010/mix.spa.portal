angular.module("angularCroppie", []).component("croppie", {
  bindings: {
    src: "<",
    ngModel: "=",
    viewportW: "=",
    viewportH: "=",
    boundaryW: "=",
    boundaryH: "=",
    outputW: "=",
    outputH: "=",
    onUpdate: "&",
    options: "<",
  },
  controller: [
    "$scope",
    "$element",
    function ($scope, $element) {
      var ctrl = this;
      this.$onInit = function () {
        var options = {
          enableExif: true,
          enableResize: true,
          enableOrientation: true,
          viewport: {
            width: ctrl.viewportW || 200,
            height: ctrl.viewportH || 200,
          },
          boundary: {
            width: ctrl.boundaryW || 300,
            height: ctrl.boundaryH || 300,
          },
        };

        options.update = function () {
          const rto = ctrl.viewport / ctrl.viewportH;
          const w = ctrl.outputW || ctrl.viewportW;
          const h = w / rto;
          c.result({
            type: "canvas",
            size: {
              width: w,
              height: h,
            },
          }).then(function (img) {
            $scope.$apply(function () {
              ctrl.ngModel = img;
            });
            if (ctrl.onUpdate) {
              ctrl.onUpdate();
            }
          });
        };

        var c = new Croppie($element[0], options);

        ctrl.$onChanges = function (changesObj) {
          var src = changesObj.src && changesObj.src.currentValue;
          if (src) {
            // bind an image to croppie
            c.bind({
              url: src,
            });
          }
        };
      };
    },
  ],
});
